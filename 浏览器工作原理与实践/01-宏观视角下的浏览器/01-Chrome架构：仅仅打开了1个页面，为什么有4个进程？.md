* 设计高性能Web应用或优化现有的Web应用,都需要了解浏览器中的 网络流程  页面渲染过程  javascript执行流程 以及 Web安全理论。通过浏览器的多进程架构的学习,可以将这些分散的知识点串起来,组成网,从而让自己能站在更高维度去理解Web应用。
* `本专栏中 分析的都是基于 Chrome浏览器。`

# 进程和线程

## 什么是并发处理
* 计算机中的并发处理就是同一时间处理多个任务
## 线程 vs 进程
* 多线程可以并行处理任务,但是`线程不能单独存在的,它是由进程来启动和管理的`
* `一个进程就是一个程序的运行实例` 详细解释就是,启动一个程序的时候,操作系统会为该程序创建一块内存,用来存放代码、运行中的数据和一个执行任务的主线程,我们把这样的一个运行环境叫进程

![](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/%E5%8D%95%E7%BA%BF%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%AF%B9%E6%AF%94%E5%9B%BE.png)

* [](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E5%85%B1%E4%BA%AB%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%A4%BA%E6%84%8F%E5%9B%BE%20.png)

*  从图中可以看到 `线程是依附于进程的,而进程中使用多线程并行处理能提升运算效率`
*  总结来说,进程和线程之间的关系有以下4个特点
  1. 进程中任意一个线程执行出错,都会导致整个进程的崩溃。
  2. 线程之间共享进程中的数据
  3. 当一个进程关闭之后,操作系统会回收进程所占用的内存。
     * 当一个进程退出时,操作系统会回收该进程所申请的所有资源。即使其中任意线程因为操作不当导致内存泄露,当进程退出时,这些内存也会被正确回收。
     * 比如之前的IE 浏览器,支持很多插件,而这些插件很容易导致内存泄露,这意味着只要浏览器开着,内存占用就有可能会越来越多,但是当关闭浏览器进程时,这些内存就会被系统回收掉。
  4. 进程之间的内容相互隔离。
     * 进程隔离是为保护操作系统中进程互不干扰的技术,每个进程只能访问自己占有的数据,也就避免进程A写入数据到进程B的情况。正是因为进程之间的数据是严格隔离的,所以一个进程如果崩溃了,或者挂起了,是不会影响到其他进程的。`如果进程之间需要进行数据的通信,这时候,就需要使用用于进程间通信(IPC)的机制`
## 单进程浏览器时代
* 单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里。包括 网络 插件  javascript运行环境 渲染引擎和页面等  

![](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/%E5%8D%95%E8%BF%9B%E7%A8%8B%E6%B5%8F%E8%A7%88%E5%99%A8%E6%9E%B6%E6%9E%84%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

* 如此多的功能模块运行子啊一个进程里,是导致单进程浏览器 不稳定 不流畅 不安全 的一个主要因素
1. 不稳定
  * 早期浏览器需要借助于插件来实现诸如Web视频、Web游戏等各种强大的功能,但是插件是最容易出问题的模块,并且还运行在浏览器进程之中,所以一个插件的意外崩溃会引起整个浏览器的崩溃
  * 除了插件之外, 渲染引擎模块也是不稳定的,通常一些复杂的javascript代码就有可能引起渲染引擎模块的崩溃。和插件一样,渲染引擎的崩溃会引起整个浏览器的崩溃。
2. 不流畅  事件循环
  * 单进程模型浏览器 由于事件循环 某个时刻只能运行一个任务。当脚本或插件 占用事件过长就会让单进程浏览器变卡顿。页面的内存泄露也是单进程变慢的一个重要原因。
3. 不安全
  * 需要从插件和页面脚本两个方面来解释该原因
  * 插件可以使用C/C++ 等代码编写,通过插件可以获取到操作系统的任意资源,当你在页面运行一个插件时也就意味着这个插件能完全操作你的电脑。如果是个恶意插件,那么它就可以释放病毒 窃取你的账号密码,引发安全性问题。
  * 至于页面脚本,它可以通过浏览器的漏洞来获取系统权限,这些脚本获取系统权限之后也可以对你的电脑做一些恶意的事情,同样也会引发安全问题。

## 多进程浏览器时代
1. 早期多进程架构

![](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/%E6%97%A9%E6%9C%9F%20Chrome%20%E8%BF%9B%E7%A8%8B%E6%9E%B6%E6%9E%84%E5%9B%BE.png) 

1. 解决不稳定的问题
  *  由于进程是相互隔离的,所以当一个页面或者插件崩溃时,影响到的仅仅是当前的页面进程或者插件进程,并不会影响到浏览器和其他页面,这就完美地解决了页面或者插件的崩溃会导致整个浏览器崩溃,也就是不稳定的问题。
2. 解决不流畅的问题
  * 同样 javascript也是运行在渲染进程中的,所以即使javascript阻塞了渲染进程,影响到的也只是当前的渲染页面,而并不会影响浏览器和其他页面,因为其他页面的脚本是运行在它们自己的渲染进程中的。所以当我们在Chrome中运行死顺序的脚本时,没有响应的仅仅是当前的页面。
  * 对于内存泄露的解决方法那就更简单了,因为当关闭一个页面时,整个渲染进程也会被关闭,之后该进程所占用的内存都会被系统回收,这样就轻松解决了浏览器页面的内存泄露问题。 
3. 解决安全问题
  * 采用多进程架构的额外好处是可以是用 `安全沙箱你可以把沙箱看成是操作系统给进程上了一般锁,沙箱里面的程序可以运行,但是不能在你的硬盘上写入任何数据,也不能在敏感位置读取任何数据。`例如你的文档和桌面。Chrome把插件进程和渲染进程锁在沙箱里面,这样即使在渲染进程或者插件进程里面执行了恶意程序,恶意程序也无法突破沙箱去获取系统权限。

## 目前多进程架构

![](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/%E6%9C%80%E6%96%B0%E7%9A%84%20Chrome%20%E8%BF%9B%E7%A8%8B%E6%9E%B6%E6%9E%84%E5%9B%BE.png)

1. 浏览器进程。 主要负责界面显示、用户交互 子进程管理 同时提供存储等功能。
2. 渲染进程。核心任务是将 HTML CSS  javascript 转换为用户可以与之交互的网页,排版引擎 Blink 和 javascript 引擎V8都是运行在该进程中,默认情况下,Chrome会为每个Tab标签创建一个渲染进程。出于安全考虑,渲染进程都是运行在沙箱模式下。
3. GPU进程。其实Chrome刚开始发布的时候是没有GPU进程的。而GPU的使用初衷是为了实现 3D CSS 效果,只是随后网页,Chrome的UI界面都选择采用GPU来绘制,这使得GPU成为浏览器普遍的需求。最后 Chrome 在其多进程架构上也引入了GPU进程。
4. 网络进程。主要负责页面的网络资源加载,之前是作为一个模块运行在浏览器进程里面的,直至最近才独立出来,成为一个单独的进程
5. 插件进程。 主要负责插件的运行,因为插件易崩溃,所以需要通过插件进程来隔离,以保证插件进程崩溃不会对浏览器和页面造成影响。

* 虽然多进程模型提升了浏览器的稳定性 流畅性 和安全性 但同样不可避免地带来一些问题：
* 更高的资源占用。因为每个进程都包含公共基础结构的副本(如 javascript运行环境) 这就意味这个浏览器会消耗更多的内存资源
* 更复杂的体系架构。 浏览器各个模块之间耦合性高,扩展性差等问题,会导致现在的架构已经很难适应新的需求了。


## 未来面向服务的架构
* 面向服务的架构 (”（Services Oriented Architecture，简称 SOA)
* 原来的各种模块会被重构成独立的服务(Service) 每个服务(Service) 都可以独立的进程中运行,访问服务(Service) 必须使用定义好的接口,通过IPC来通信,从而构建一个更内聚 松耦合 易于维护和扩展的系统
* `Chrome还提供灵活的弹性架构,在强大性能设备上会以多进程的方式运行基础服务,但是如果在资源受限的设备上,Chrome会将很多服务整合到一个进程中,从而节省内存占用。`

![](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/Chrome%E2%80%9C%E9%9D%A2%E5%90%91%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9E%B6%E6%9E%84%E2%80%9D%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%9B%BE.png)

![](https://raw.githubusercontent.com/1391020381/Front-end-Advancement/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/note/img/%E5%9C%A8%E8%B5%84%E6%BA%90%E4%B8%8D%E8%B6%B3%E7%9A%84%E8%AE%BE%E5%A4%87%E4%B8%8A%EF%BC%8C%E5%B0%86%E6%9C%8D%E5%8A%A1%E5%90%88%E5%B9%B6%E5%88%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%9B%E7%A8%8B%E4%B8%AD.png)



# 总结
* 主要是从 Chrome进程架构的视角,分析了浏览器的进化史。
* 单进程  多进程   面向服务架构
* Chrome 是以一个非常快速的速度在进化，越来越多的业务和应用都逐渐转至浏览器来开发，身为开发人员，我们不能坐视不管，而应该紧跟其步伐，收获这波技术红利


# 问答
1. 
* https://time.geekbang.org  https://www.geekbang.org  https://www.geekbang.org:8080  都属于同一站点 ,因为它们的协议都是https 而根域名也都是geekbang.org
* Chrome的默认策略是，每个标签对应一个渲染进程.但是如果从一个页面打开了新页面,而新页面和当前页面属于 同一站点时, 那么新页面会复用父页面的渲染进程。官方把这个默认策略叫 process-per-instance
* 它们在一个渲染进程里面,它们就会共享js执行环境,也就是说A页面可以直接在B页面中执行脚本。因为是同一家的站点 所以是有这个需求的。
2. UA
* 我们知道了服务器会根据不同的UA来针对性的设计不同的页面,所以当出了一款新浏览器时,他如果使用自己独一无二的UA，那么之前的很多服务器还需要针对他来做页面适配。


* IE6时代浏览器是单进程的,所有页面也都是运行子啊一个主线程中的,当时IE6就是这样设计,而且此时的IE6是单标签,也就是说一个页面一个窗口
* 这时候,国内有很多国产浏览器,都是基于IE6来二次开发的,而IE6原生架构就是所有页面跑在单线程里面的,意味着所有的页面都共享着统一套javascript运行环境,同样,对于存储Cookie也都是在一个线程里面操作的。
* 而且这些国产浏览器由于需要,都采用多标签的形式,所以其中的一个标签页面的卡顿都会影响到整个浏览器。
* 基于卡顿的原因,国内的浏览器就开始尝试支持页面多线程,也就是让部分页面运行在单独的线程之中,运行在单独的线程之中,意味着每个线程拥有单独的javascript执行环境,和Cookie环境。
* 这个会有一个问题,比如A站点页面登录一个网站,保存了一些Cookie数据到磁盘上,再在当前线程环境中保存部分Session数据,由于Session是不需要保存到硬盘上的,所以Session只会保存在当前的线程环境中。这时候再打开另一个A站点的页面,假设这个页面在另外一个线程中里面,那么它首先读取硬盘上的Cookie信息,但是,由于Session信息保存在另外一个线程里面的,无法直接读取,这样要实现一个Session同步的问题,由于IE并没有源码,所以实现起来非常困难,国内浏览器花了好长时间才解决这个问题。


* 如果打开了 2个页面,会有几个进程呢?是 1个网络进程 1个浏览器进程 1个GPU进程以及 2个渲染进程？
* 通常情况下会是5个
1. 如果页面里面有iframe 的话,iframe也会运行在单独的进程中
2. 如果页面里有插件,同样插件也需要开启一个单独的进程
3. 如果你装了扩展的话,扩展也会占用进程
4. 如果2个页面属于同一站点的话,并且从a页面中打开的b页面,那么他们会公用一个渲染进程


* 要定位页面崩溃,我们先要了解有可能造成页面崩溃的因素,根据我的实际统计数据来看,主要有以下三个方面的因素：
1. 首先,主要因素是一些第三方插件注入浏览器或者页面进程,拦截了网页的一些正常操作而导致页面或者浏览器崩溃,如一些杀毒软件,或者卫士类软件,或者一些浏览劫持软件。
2. 第二个因素是插件,虽然容易崩溃,但是通常情况下只会影响到自身的进程,不过我们以前的统计数据来看,也会笑概率低影响到页面的崩溃,不过整体数据来看还好了。另外一个方向来看,插件的使用率已经越来越低了,所以插件不是个大问题。
3. 浏览器的一些bug,如渲染引擎,javascript引擎等,不过从统计数据来看,这类因素导致的崩溃也是越来越低的了,而且随着浏览器的更新升级,引擎问题的因素也是在不断变化的。

* 要直接给出页面崩溃原因是很难的,而且直接从js层来看,也是很难跟踪崩溃原因的。
* 使用js来统计页面是否崩溃,这类统计不是100%准确,但是可以通过数据大致判断页面是否崩溃,然后再找一些典型的用户环境来实地排查。



* Chrome支持使用JavaScript来写连接代理服务器脚本，又称为在线pac代理脚本，pac脚本具体什么样子你可以搜索“PAC代理脚本”，总之使用pac代理脚本可以实现一些那啥的事。


* 单进程浏览器不使用安全沙箱的原因:如果一个进程使用了安全沙箱之后,该进程对于操作系统的权限就会受到限制,比如不能对一些位置的文件进行读写操作,而这些权限浏览器主进程所需要的,所以安全沙箱是不能应用到浏览器主进程之上的。

